<script>
// GitHub에서 JSON 파일 가져오기
async function fetchNotices() {
    const url = "https://api.github.com/repos/lee1431/web/contents/notices.json";

    try {
        const response = await fetch(url, {
            headers: {
                'Accept': 'application/vnd.github.v3+json' // JSON 형식으로 요청
            }
        });
        if (!response.ok) throw new Error(`네트워크 응답이 불량합니다. 상태 코드: ${response.status}`);
        
        const data = await response.json();
        
        // Base64로 인코딩된 데이터를 디코딩
        const decodedContent = atob(data.content);
        const notices = JSON.parse(decodedContent); // JSON 파싱

        return { notices, sha: data.sha };
    } catch (error) {
        console.error('공지사항 데이터를 가져오는 중 오류가 발생했습니다.', error);
        return { notices: [], sha: null };
    }
}

// 공지사항 추가 폼 제출 처리
document.getElementById('noticeForm').addEventListener('submit', async function (e) {
    e.preventDefault();

    // 입력된 제목과 내용 가져오기
    const title = document.getElementById('title').value;
    const content = document.getElementById('content').value;

    // 기존 JSON 파일 가져오기
    const { notices, sha } = await fetchNotices();
    
    if (!sha) {
        alert('기존 공지사항 데이터를 가져오는 데 실패했습니다.');
        return;
    }

    // 새로운 공지사항 추가
    const newNotice = {
        title,
        content,
        date: new Date().toISOString().split('T')[0], // 현재 날짜 추가
        link: "#", // 링크는 기본값으로 설정
        file: null // 파일 첨부는 기본값
    };
    notices.push(newNotice);

    // GitHub에 업데이트할 데이터 설정
    const updateData = {
        message: "공지사항 업데이트",
        content: toBase64(JSON.stringify(notices, null, 2)), // Base64로 인코딩된 JSON 데이터
        sha // 기존 파일의 SHA 값을 사용하여 업데이트
    };

    // GitHub API로 업데이트 요청 보내기
    try {
        const updateResponse = await fetch("https://api.github.com/repos/lee1431/web/contents/notices.json", {
            method: 'PUT',
            headers: {
                'Authorization': `Bearer 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`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(updateData)
        });
        
        if (!updateResponse.ok) {
            throw new Error(`GitHub API 요청 실패, 상태 코드: ${updateResponse.status}`);
        }

        alert("공지사항이 성공적으로 추가되었습니다.");
        document.getElementById('noticeForm').reset(); // 폼 초기화
    } catch (error) {
        console.error("공지사항 추가 중 오류 발생:", error);
    }
});

// UTF-8 인코딩 후 Base64 인코딩 함수
function toBase64(str) {
    return btoa(unescape(encodeURIComponent(str)));
}

</script>
